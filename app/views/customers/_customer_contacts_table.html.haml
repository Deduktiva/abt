-# Customer contacts table with add form wrapped in div
%div{id: "customer_contacts_#{customer.id}"}
  %table.table.table-striped.table-sm
    %thead
      %tr
        %th{style: 'width: 20%; padding: 0.75rem; font-weight: 600;'} Name
        %th{style: 'width: 25%; padding: 0.75rem; font-weight: 600;'} Email
        %th{style: 'width: 20%; padding: 0.75rem; font-weight: 600;'} Document Types
        %th{style: 'width: 25%; padding: 0.75rem; font-weight: 600;'} Projects
        %th.text-center{style: 'width: 10%; padding: 0.75rem; font-weight: 600;'} Actions
    %tbody
      - customer.customer_contacts.each do |contact|
        = render 'customers/customer_contact_row', contact: contact

  - if local_assigns[:show_new_form]
    %h6.mt-3 Add New Contact
    - contact_object = customer.customer_contacts.build(local_assigns[:failed_contact_attributes] || {})
    = form_with model: [customer, contact_object],
      url: customer_customer_contacts_path(customer),
      local: false,
      format: :turbo_stream do |f|
      - if local_assigns[:new_contact_errors]
        .alert.alert-danger.mb-3
          = local_assigns[:new_contact_errors].full_messages.join(", ")
      .row.g-2
        .col-md-3
          = f.text_field :name, class: "form-control", placeholder: "Contact name", required: true
        .col-md-3
          = f.email_field :email, class: "form-control", placeholder: "email@example.com", required: true
        .col-md-2
          .form-check
            = f.check_box :receives_invoices, class: "form-check-input", checked: true
            = f.label :receives_invoices, "Invoices", class: "form-check-label"
        .col-md-2
          - customer_projects = Project.active.where(bill_to_customer: customer)
          - if customer_projects.any?
            = f.select :project_ids, options_from_collection_for_select(customer_projects, :id, :display_name, contact_object.project_ids),
              { include_blank: "Select projects..." },
              { multiple: true, class: "form-select form-select-sm", size: 3 }
          - else
            %small.text-muted No projects available
        .col-md-2
          = f.submit "Save", class: "btn btn-success"
          = link_to "Cancel", cancel_new_customer_customer_contacts_path(customer, format: :turbo_stream),
            class: "btn btn-secondary ms-1",
            data: { turbo_frame: "customer_contacts_#{customer.id}" }