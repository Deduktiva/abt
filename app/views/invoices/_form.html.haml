= form_for(@invoice) do |f|
  - if @invoice.errors.any?
    #error_explanation
      %h2
        = pluralize(@invoice.errors.count, 'error')
        prohibited this invoice from being saved:

      %ul
        - @invoice.errors.full_messages.each do |msg|
          %li= msg

  .form-inputs
    .row
      .col-sm-4
        .mb-3
          %label.form-label Customer
          = f.collection_select :customer_id, Customer.all, :id, :name, {}, {class: 'form-select'}
      .col-sm-4
        .mb-3
          %label.form-label Project
          = f.collection_select :project_id, Project.all, :id, :matchcode, {}, {class: 'form-select'}
      .col-sm-4
        .mb-3
          %label.form-label Date
          .form-control-plaintext (set at booking)

    .row
      .col-sm-4
        .mb-3
          %label.form-label Customer reference
          = f.text_field :cust_reference, class: 'form-control'
      .col-sm-4
        .mb-3
          %label.form-label Customer Order No
          = f.text_field :cust_order, class: 'form-control'

    .row
      .col-sm-12
        .mb-3
          %label.form-label Prelude
          = f.text_area :prelude, class: 'form-control', rows: 2, placeholder: 'Thank you for your business...'

    - unless @invoice.id.nil?
      %div{data: {controller: 'invoice-lines'}}
        / Lines container
        %div{data: {invoice_lines_target: 'container'}}
          = f.fields_for :invoice_lines do |line_form|
            = render 'invoice_line_fields', f: line_form, line: line_form.object

        / Template for new lines
        %template{data: {invoice_lines_target: 'template'}}
          - new_line = @invoice.invoice_lines.build(type: "item", amount: 0, rate: 0, quantity: 1)
          = f.fields_for :invoice_lines, new_line, child_index: 'NEW_RECORD' do |line_form|
            = render 'invoice_line_fields', f: line_form, line: new_line

        .row
          .col-sm-10
          .col-sm-2.text-end
            .mb-3
              %label.form-label Total
              .form-control-plaintext{data: {invoice_lines_target: 'total'}}
                = format_currency(0)

        %br{clear: 'all'}
        %button.btn.btn-info.float-end{type: 'button', data: {action: 'click->invoice-lines#addLine'}}
          + Add Line

  %br
  .form-actions
    = f.submit 'Save', class: 'btn btn-primary'
    = link_to 'Cancel', invoices_path, class: 'btn btn-secondary ms-2'