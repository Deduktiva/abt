%div
  .invoice-header.row.mb-2
    .col-md-6
      %h1.h2.mb-3
        Invoice
        = @invoice.document_number || "Draft \##{@invoice.id}"
        - if not @invoice.published?
          %span.badge.bg-warning.ms-2 Draft
        - else
          %span.badge.bg-success.ms-2 Booked

      .invoice-details
        - if @invoice.date
          .row.mb-2
            .col-sm-4
              %strong Date:
            .col-sm-8
              = format_date(@invoice.date)
        .row.mb-2
          .col-sm-4
            %strong Customer:
          .col-sm-8
            = @invoice.customer_name || @invoice.customer.name

    .col-md-6
      .invoice-details.mt-md-5
        - if @invoice.project_id.present?
          .row.mb-2
            .col-sm-4
              %strong Project:
            .col-sm-8
              - if @invoice.project
                = @invoice.project.display_name
              - else
                %em (Project ##{@invoice.project_id} - not found)
        - if @invoice.cust_reference.present?
          .row.mb-2
            .col-sm-4
              %strong Reference:
            .col-sm-8
              = @invoice.cust_reference
        - if @invoice.cust_order.present?
          .row.mb-2
            .col-sm-4
              %strong Order No:
            .col-sm-8
              = @invoice.cust_order
        - if @invoice.token.present?
          .row.mb-2
            .col-sm-4
              %strong Token:
            .col-sm-8
              .small.text-muted= @invoice.token
        - if @invoice.published?
          .row.mb-2
            .col-sm-4
              %strong Email Status:
            .col-sm-8
              - if @invoice.email_sent_at
                %span.badge.bg-success Sent #{format_datetime(@invoice.email_sent_at)}
              - elsif @invoice.customer.email.present? || @invoice.customer.invoice_email_auto_enabled
                %span.badge.bg-warning Unsent
              - else
                %span.badge.bg-secondary No Email Address

  - if @invoice.prelude.present?
    .invoice-prelude.mb-4
      .card
        .card-body
          = simple_format(@invoice.prelude)

  .invoice-lines.mb-2
    %table.table.table-bordered
      %thead
        %tr
          %th{style: "width: 55%"} Description
          %th.text-end{style: "width: 10%"} Quantity
          %th.text-end{style: "width: 15%"} Rate
          %th.text-center{style: "width: 10%"} Tax Class
          %th.text-end{style: "width: 15%"} Amount
      %tbody
        - @invoice.invoice_lines.each do |line|
          - case line.type
          - when 'item'
            %tr
              %td
                %strong= line.title
                - if line.description.present?
                  %br
                  %small.text-muted= simple_format(line.description, {}, wrapper_tag: 'span')
              %td.text-end
                = number_with_precision(line.quantity, precision: 2, strip_insignificant_zeros: true)
              %td.text-end
                = format_currency(line.rate)
              %td.text-center
                %small= line.sales_tax_product_class&.name
              %td.text-end
                %strong= format_currency(line.amount || (line.quantity * line.rate))
          - when 'subheading'
            %tr
              %td.fw-bold.table-secondary{colspan: 5, style: "padding: 12px 8px;"}
                = line.title
          - when 'text', 'plain'
            %tr
              %td{colspan: 5, style: "padding: 8px;"}
                - if line.title.present?
                  %div= line.title
                - if line.description.present?
                  %div.text-muted{style: "margin-left: 20px;"}
                    - if line.type == 'plain'
                      %pre.mb-0{style: "font-family: monospace; white-space: pre-wrap;"}= line.description
                    - else
                      = simple_format(line.description)

  .invoice-summary
    .row.justify-content-end
      .col-md-4
        %table.table.table-sm
          %tbody
            %tr
              %td.text-end
                %strong Sum Net:
              %td.text-end
                %strong= format_currency(@invoice.sum_net)
            - if @invoice.invoice_tax_classes.any?
              - @invoice.invoice_tax_classes.each do |tax_class|
                %tr
                  %td.text-end
                    Tax (#{tax_class.rate}%):
                  %td.text-end
                    = format_currency(tax_class.value)
            %tr.table-dark
              %td.text-end
                %strong Sum Total:
              %td.text-end
                %strong= format_currency(@invoice.sum_total)

.email-preview-wrapper{"data-controller" => "email-preview", "data-email-preview-invoice-id-value" => @invoice.id}
  = action_buttons_wrapper do
    = action_button 'Back', invoices_path, :secondary
    - unless @invoice.published
      = action_button 'Edit', edit_invoice_path(@invoice), :primary
    - if @invoice.attachment
      = action_button 'PDF', @invoice.attachment, :success, { target: '_blank', data: { turbo: false } }
      - if @invoice.customer&.email.present? || (@invoice.customer&.invoice_email_auto_enabled && @invoice.customer&.invoice_email_auto_to.present?)
        %button.btn.btn-warning{"data-action" => "click->email-preview#open"}
          Send E-Mail
    - else
      = action_button 'Preview', preview_invoice_path(@invoice), :info, { target: '_blank', data: { turbo: false } }
    - unless @invoice.published
      = button_to 'Test Booking', book_invoice_path(@invoice, :save => false), method: :post, class: 'btn btn-warning'
      = destroy_link(@invoice, "Are you sure you want to delete invoice \"#{@invoice.document_number || "##{@invoice.id}"}\"?")

  // Email Preview Modal
  .modal.d-none{"data-email-preview-target" => "modal", "data-action" => "click->email-preview#closeOnBackdrop keydown@window->email-preview#closeOnEscape", "style" => "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; display: flex; align-items: center; justify-content: center;"}
    .modal-dialog.modal-lg{"style" => "max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;"}
      .modal-content
        .modal-header.d-flex.justify-content-between.align-items-center
          %h5.modal-title.mb-0
            Preview - Invoice #{@invoice.document_number}
          .d-flex.align-items-center
            %button.btn.btn-success.btn-sm.me-2{"data-action" => "click->email-preview#sendEmail"}
              Send E-Mail
            %button.btn-close{"type" => "button", "data-action" => "click->email-preview#close", "aria-label" => "Close"}
        .modal-body{"data-email-preview-target" => "content"}
          .text-center
            .spinner-border{"role" => "status"}
              %span.visually-hidden Loading...
            %p Loading email preview...
