# Apache2 Reverse Proxy Configuration for ABT and Future Applications
# This configuration allows multiple applications to be served under different paths
# Place this in /etc/apache2/sites-available/ and enable with a2ensite

<VirtualHost *:443>
    ServerName your-tailscale-hostname
    
    # SSL Configuration (configure certificates as needed)
    SSLEngine on
    # SSLCertificateFile /path/to/your/certificate.crt
    # SSLCertificateKeyFile /path/to/your/private.key
    
    # Enable required modules for reverse proxy
    # a2enmod proxy proxy_http proxy_balancer lbmethod_byrequests headers ssl rewrite
    
    # Security headers
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Root redirect to ABT (or a landing page)
    RewriteEngine On
    RewriteRule ^/?$ /abt/ [R=301,L]
    
    # ABT Application Proxy
    <Location "/abt/">
        ProxyPreserveHost On
        ProxyPass http://localhost:8080/
        ProxyPassReverse http://localhost:8080/
        
        # Pass original request information
        ProxyPassReverse http://localhost:8080/
        ProxySetHeader Host $host
        ProxySetHeader X-Real-IP $remote_addr
        ProxySetHeader X-Forwarded-For $proxy_add_x_forwarded_for
        ProxySetHeader X-Forwarded-Proto $scheme
        ProxySetHeader X-Forwarded-Host $host
        ProxySetHeader X-Forwarded-Port $server_port
        
        # Tell Rails app it's running under /abt/ path
        ProxySetHeader X-Forwarded-Prefix /abt
    </Location>
    
    # Future: Paperless-NGX Application Proxy
    # <Location "/paperless/">
    #     ProxyPreserveHost On
    #     ProxyPass http://localhost:8001/
    #     ProxyPassReverse http://localhost:8001/
    #     
    #     ProxySetHeader Host $host
    #     ProxySetHeader X-Real-IP $remote_addr
    #     ProxySetHeader X-Forwarded-For $proxy_add_x_forwarded_for
    #     ProxySetHeader X-Forwarded-Proto $scheme
    #     ProxySetHeader X-Forwarded-Host $host
    #     ProxySetHeader X-Forwarded-Port $server_port
    #     ProxySetHeader X-Forwarded-Prefix /paperless
    # </Location>
    
    # Health check endpoint (bypasses proxy)
    <Location "/health">
        SetHandler server-info
        Require local
    </Location>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/reverse_proxy_error.log
    CustomLog ${APACHE_LOG_DIR}/reverse_proxy_access.log combined
    LogLevel info
    
    # Optional: Status page for monitoring
    <Location "/server-status">
        SetHandler server-status
        Require local
    </Location>
</VirtualHost>

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName your-tailscale-hostname
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>